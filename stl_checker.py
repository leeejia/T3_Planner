from staliro.models import Trace
from staliro.specifications import rtamt
import ast
import numpy as np

def sample_trajectory(lst): 
    if len(lst) <= 1:
        return lst
    
    sampling_period = 0.5
    
    result = []
    for item in lst:
        pos, time = item[0], item[1]

        corrected_time = round(time / sampling_period) * sampling_period
        result.append([list(pos), corrected_time])
    
    final_result = []
    for i in range(len(result)):
        final_result.append(result[i])
        
        if i < len(result) - 1:
            t1, t2 = result[i][1], result[i + 1][1]
            pos1, pos2 = result[i][0], result[i + 1][0]
            
            time_diff = t2 - t1
            if time_diff > sampling_period:

                n_steps = int(time_diff / sampling_period)
                for step in range(1, n_steps):
                    t_interp = t1 + step * sampling_period

                    alpha = (t_interp - t1) / (t2 - t1)
                    pos_interp = [pos1[0] + alpha * (pos2[0] - pos1[0]),
                                 pos1[1] + alpha * (pos2[1] - pos1[1])]
                    final_result.append([pos_interp, t_interp])
    
    return final_result

def add_more_points(target_list):
    '''[[1.0, 8.0], [6.0, 9.0], [8.0, 8.0]]extend[[1.0, 8.0], [1.5, 8.0], [2.0, 8.0], [2.5, 8.0], [3.0, 8.0], [3.5, 8.0], [4.0, 8.0], [4.5, 8.0], [5.0, 8.0],'''
    waypoint = []
    for i in range(len(target_list) - 1):
        start = target_list[i]
        end = target_list[i + 1]
        waypoint.append(start)
        for j in range(1, 15):
            x = start[0] + round((end[0] - start[0]) * j / 15, 4)
            y = start[1] + round((end[1] - start[1]) * j / 15, 4)
            waypoint.append([x, y])
    waypoint.append(target_list[-1])
    return waypoint

def add_more_pwl_points(target_list):
    '''[[[0,0],0] [[2,3],3] [[6,3],6]]extend[[1.0, 8.0], [1.5, 8.0], [2.0, 8.0], [2.5, 8.0], [3.0, 8.0], [3.5, 8.0], [4.0, 8.0], [4.5, 8.0], [5.0, 8.0],'''
    waypoint = []
    for i in range(len(target_list) - 1):
        start = target_list[i][0]
        end = target_list[i + 1][0]
        time_start = target_list[i][1]
        time_end = target_list[i + 1][1]
        waypoint.append([start,time_start])
        for j in range(1, 10):
            x = start[0] + round((end[0] - start[0]) * j / 10, 4)
            y = start[1] + round((end[1] - start[1]) * j / 10, 4)
            time = time_start + round((time_end - time_start) * j / 10, 4)
            waypoint.append([[x, y],time])
    waypoint.append(target_list[-1])

    return waypoint

def target2pwl(target):
    pwl_target = [[pos,i] for i,pos in enumerate(target)] 

    return pwl_target


def process_data(lst):
    result = {}
    for sub_lst in lst:
        inner_lst, key = sub_lst
        result[key] = [float(x) for x in inner_lst]

    return result

def stl_monitor_for_pwl(lst, stl): 
    
    lst = add_more_pwl_points(lst)
    states = process_data(lst) 
    specification = rtamt.parse_discrete(stl, {"x": 0,"y": 1})
    value=specification.evaluate(Trace(states))
    value = value.value
    return value

def stl_monitor_for_target(lst, stl):

    lst = add_more_points(lst)
    lst = target2pwl(lst)
    states = process_data(lst) 
    specification = rtamt.parse_discrete(stl, {"x": 0,"y": 1})
    value=specification.evaluate(Trace(states))
    value = value.value
    return value


def stl_monitor_for_pwl_sampling_period(lst, stl): 
    lst = sample_trajectory(lst)
    #lst = add_more_points(lst)
    #lst = target2pwl(lst)
    states = process_data(lst) 
    specification = rtamt.parse_discrete(stl, {"x": 0,"y": 1})
    value=specification.evaluate(Trace(states))
    value = value.value
    return value


if __name__ == "__main__":
    lst= [[[1.0156817630765964, 2.056487317166662], 0], [[1.0567066344518024, 2.0987281065326058], 0.1], [[1.100365874488906, 2.1382457391086858], 0.2], [[1.1441020397572756, 2.177678223141589], 0.3], [[1.1878406061821978, 2.217108043796877], 0.4], [[1.2315792500609983, 2.2565377785342475], 0.5], [[1.2753178965215917, 2.295967510407685], 0.6], [[1.3190565430712125, 2.335397242182366], 0.7], [[1.3627951896240127, 2.37482697395352], 0.8], [[1.4065338361769308, 2.4142567057245437], 0.9], [[1.4502724827298534, 2.4536864374955623], 1.0], [[1.4940111292827762, 2.4931161692665804], 1.1], [[1.537749775835699, 2.5325459010375986], 1.2], [[1.5814884223886219, 2.5719756328086167], 1.3], [[1.6252270689415447, 2.611405364579635], 1.4], [[1.6689657154944675, 2.650835096350653], 1.5], [[1.7127043620473903, 2.6902648281216712], 1.6], [[1.756443008600313, 2.7296945598926894], 1.7], [[1.800181655153236, 2.7691242916637075], 1.8], [[1.8439203017061587, 2.8085540234347257], 1.9], [[1.8876589482590815, 2.847983755205744], 2.0], [[1.9313975948120043, 2.887413486976762], 2.1], [[1.9751362413649272, 2.92684321874778], 2.2], [[2.0188748879178497, 2.9662729505187984], 2.3], [[2.0626135344707723, 3.0057026822898165], 2.4], [[2.1063521810236954, 3.0451324140608347], 2.5], [[2.1500908275766184, 3.0845621458318533], 2.6], [[2.193829474129541, 3.1239918776028714], 2.7], [[2.2375681206824636, 3.16342160937389], 2.8], [[2.281306767235386, 3.2028513411449087], 2.9], [[2.325045413788309, 3.2422810729159273], 3.0], [[2.3687840603412322, 3.2817108046869454], 3.1], [[2.4125227068941553, 3.3211405364579636], 3.2], [[2.4562613534470783, 3.3605702682289817], 3.3], [[2.457628186151857, 3.361802447346826], 3.3], [[2.4881134949365085, 3.3892844945309126], 3.3], [[2.5281025255262177, 3.398801117434209], 3.4], [[2.5688832497330303, 3.4039769295759026], 3.5], [[2.609668698381606, 3.4091153815823914], 3.6], [[2.6504541876080565, 3.414253511499842], 3.7], [[2.691239677187347, 3.419391638616517], 3.8], [[2.7320251667697324, 3.4245297657086238], 3.9], [[2.7728106563521453, 3.429667892800513], 4.0], [[2.813596145934558, 3.4348060198924], 4.1], [[2.854381635516971, 3.4399441469842875], 4.2], [[2.895167125099384, 3.445082274076175], 4.3], [[2.935952614681797, 3.450220401168062], 4.4], [[2.97673810426421, 3.4553585282599495], 4.5], [[3.0175235938466227, 3.460496655351837], 4.6], [[3.0583090834290356, 3.465634782443724], 4.7], [[3.099094573011449, 3.4707729095356115], 4.8], [[3.139880062593862, 3.475911036627499], 4.9], [[3.180665552176275, 3.481049163719386], 5.0], [[3.2214510417586877, 3.4861872908112734], 5.1], [[3.2622365313411006, 3.4913254179031608], 5.2], [[3.303022020923514, 3.496463544995048], 5.3], [[3.343807510505927, 3.5016016720869354], 5.4], [[3.3845930000883397, 3.5067397991788227], 5.5], [[3.4253784896707526, 3.51187792627071], 5.6], [[3.4661639792531656, 3.5170160533625974], 5.7], [[3.5069494688355785, 3.5221541804544847], 5.8], [[3.5477349584179914, 3.527292307546372], 5.9], [[3.5885204480004043, 3.5324304346382593], 6.0], [[3.629305937582817, 3.5375685617301467], 6.1], [[3.67009142716523, 3.542706688822034], 6.2], [[3.710876916747643, 3.5478448159139213], 
6.3], [[3.751662406330056, 3.5529829430058086], 6.4], [[3.792447895912469, 3.558121070097696], 6.5], [[3.8332333854948817, 3.5632591971895833], 6.6], [[3.8740188750772946, 3.5683973242814706], 6.7], [[3.914804364659708, 3.573535451373358], 6.8], [[3.955589854242121, 3.5786735784652453], 6.9], [[3.9963753438245337, 3.5838117055571326], 7.0], [[4.037160833406947, 3.58894983264902], 7.1], [[4.07794632298936, 3.5940879597409072], 7.2], [[4.118731812571774, 3.5992260868327945], 7.3], [[4.159517302154187, 3.604364213924682], 7.4], [[4.2003027917366005, 3.609502341016569], 7.5], [[4.241088281319014, 3.6146404681084565], 7.6], [[4.281873770901427, 3.619778595200344], 7.7], [[4.3226592604838405, 3.624916722292231], 7.8], [[4.363444750066254, 3.6300548493841185], 7.9], [[4.404230239648667, 3.635192976476006], 8.0], [[4.445015729231081, 3.640331103567893], 8.1], [[4.485801218813494, 3.6454692306597805], 8.2], [[4.526586708395907, 3.650607357751668], 8.3], [[4.567372197978321, 3.655745484843555], 8.4], [[4.608157687560734, 3.6608836119354424], 8.5], [[4.648943177143147, 3.6660217390273298], 8.6], [[4.689728666725561, 3.671159866119217], 8.7], [[4.730514156307974, 3.6762979932111044], 8.8], [[4.771299645890387, 3.6814361203029917], 8.9], [[4.812085135472801, 3.686574247394879], 9.0], [[4.852870625055214, 3.6917123744867664], 9.1], [[4.893656114637627, 3.6968505015786537], 9.2], [[4.934441604220041, 3.701988628670541], 9.3], [[4.975227093802454, 3.7071267557624283], 9.4], [[5.016012583384867, 3.7122648828543157], 9.5], [[5.056798072967281, 3.717403009946203], 9.6], [[5.097583562549694, 3.7225411370380903], 9.7], [[5.1383690521321075, 3.7276792641299776], 9.8], [[5.179154541714521, 3.732817391221865], 9.9], [[5.219940031296934, 3.7379555183137523], 10.0], [[5.2607255208793475, 3.7430936454056396], 10.1], [[5.30151101046176, 3.748231772497527], 10.2], [[5.3422965000441724, 3.7533698995894142], 10.3], [[5.383081989626585, 3.7585080266813016], 10.4], [[5.423867479208997, 3.763646153773189], 10.5], [[5.464652968791411, 3.768784280865076], 10.6], [[5.505438458373824, 3.7739224079569635], 10.7], [[5.5462239479562365, 3.779060535048851], 10.8], [[5.587009437538649, 3.784198662140738], 10.9], [[5.627794927121062, 3.7893367892326255], 11.0], [[5.668580416703475, 3.794474916324513], 11.1], [[5.709365906285887, 3.7996130434164], 11.2], [[5.7501513958683, 3.8047511705082875], 11.3], [[5.790936885450712, 3.809889297600175], 11.4], [[5.8317223750331255, 3.815027424692062], 11.5], [[5.872507864615539, 3.8201655517839495], 11.6], [[5.913293354197951, 3.8253036788758368], 11.7], [[5.954078843780364, 3.830441805967724], 11.8], [[5.994864333362776, 3.8355799330596114], 11.9], [[6.035649822945189, 3.8407180601514987], 12.0], [[6.076435312527602, 3.8458561872433856], 12.1], [[6.117220802110015, 3.8509943143352725], 12.2], [[6.158006291692428, 3.8561324414271594], 12.3], [[6.19879178127484, 3.8612705685190467], 12.4], [[6.239577270857253, 3.866408695610934], 12.5], [[6.280362760439665, 3.8715468227028214], 12.6], [[6.321148250022079, 3.8766849497947082], 12.7], [[6.361933739604492, 3.881823076886595], 12.8], [[6.402719229186904, 3.886961203978482], 12.9], [[6.443504718769317, 3.8920993310703693], 13.0], [[6.484290208351729, 3.8972374581622566], 13.1], [[6.525075697934143, 3.9023755852541435], 13.2], [[6.565861187516555, 3.9075137123460304], 
13.3], [[6.6066466770989685, 3.9126518394379173], 13.4], [[6.647432166681381, 3.9177899665298046], 13.5], [[6.688217656263793, 3.922928093621692], 13.6], [[6.729003145846206, 3.9280662207135792], 13.7], [[6.769788635428619, 3.933204347805466], 13.8], [[6.810574125011032, 3.938342474897353], 13.9], [[6.851359614593445, 3.94348060198924], 14.0], [[6.8921451041758575, 3.948618729081127], 14.1], [[6.93293059375827, 3.9537568561730145], 14.2], [[6.973716083340682, 3.958894983264902], 14.3], [[7.014501572923096, 3.9640331103567887], 14.4], [[7.055287062505508, 3.9691712374486756], 14.5], [[7.096072552087921, 3.9743093645405625], 14.6], [[7.136858041670334, 3.97944749163245], 14.7], [[7.1776435312527465, 3.984585618724337], 14.8], [[7.218429020835159, 3.989723745816224], 14.9], [[7.2960720081384105, 3.9995051543672178], 14.9], [[7.360684065594417, 4.046153106159205], 15.0], [[7.395322051073958, 4.118695052456219], 15.1], [[7.398568344362878, 4.1991754371320305], 15.2], [[7.401060679211787, 4.279682786024629], 15.3], [[7.403534622033859, 4.360190702245974], 15.4], [[7.406008105053565, 4.440698632595391], 15.5], [[7.4084815762834655, 4.521206563307032], 15.6], [[7.4109550472031085, 4.601714494028205], 15.7], [[7.413428518114366, 4.682222424749636], 15.8], [[7.415901989025391, 4.762730355471073], 15.9], [[7.418375459936409, 4.843238286192512], 16.0], [[7.420848930847427, 4.92374621691395], 16.1], [[7.423322401758445, 5.004254147635389], 16.2], [[7.425795872669463, 5.084762078356827], 16.3], [[7.428269343580481, 5.165270009078266], 16.4], [[7.430742814491499, 5.245777939799704], 16.5], [[7.4332162854025166, 5.326285870521143], 16.6], [[7.4356897563135345, 5.406793801242581], 16.7], [[7.438163227224552, 5.48730173196402], 16.8], [[7.44063669813557, 5.567809662685458], 16.9], [[7.443110169046588, 5.6483175934068965], 17.0], [[7.445583639957606, 5.728825524128335], 17.1], [[7.448057110868624, 5.8093334548497735], 17.2], [[7.450530581779642, 5.889841385571212], 17.3], [[7.45300405269066, 5.97034931629265], 17.4], [[7.455477523601678, 6.050857247014089], 17.5], [[7.457950994512696, 6.131365177735527], 17.6], [[7.4604244654237135, 6.211873108456966], 17.7], [[7.462897936334731, 6.292381039178404], 17.8], [[7.465371407245749, 6.372888969899844], 17.9], [[7.467844878156767, 6.453396900621283], 18.0], [[7.470318349067785, 6.533904831342722], 18.1], [[7.472791819978803, 6.614412762064162], 18.2], [[7.475265290889821, 6.694920692785601], 18.3], [[7.477738761800839, 6.7754286235070404], 18.4], [[7.480212232711857, 6.85593655422848], 18.5], [[7.482685703622875, 6.936444484949919], 18.6], [[7.485159174533893, 7.0169524156713585], 18.7], [[7.4876326454449105, 7.097460346392799], 18.8], [[7.490106116355928, 7.177968277114239], 18.9], [[7.492579587266946, 7.258476207835679], 19.0], [[7.495053058177964, 7.33898413855712], 19.1], [[7.497526529088982, 7.4194920692785615], 19.2], [[7.499390105935525, 7.480148822906545], 19.2], [[7.471319883895047, 
7.535506681912891], 19.3], [[7.419395695097305, 7.571145151407935], 19.4], [[7.356305020353584, 7.577571573266772], 19.5], [[7.295856438178787, 7.558065249931579], 19.6], [[7.235554461343234, 7.538110210202921], 19.7], [[7.17525528325277, 7.518146714917346], 19.8], [[7.114956158996164, 7.498183057028827], 19.9], [[7.054657035795129, 7.478219395952016], 20.0], [[6.994357912615206, 7.4582557348114396], 20.1], [[6.934058789435713, 7.438292073669562], 20.2], [[6.873759666256229, 7.418328412527656], 20.3], [[6.813460543076745, 7.398364751385751], 20.4], [[6.753161419897262, 7.3784010902438455], 20.5], [[6.692862296717779, 7.35843742910194], 20.6], [[6.632563173538296, 7.338473767960035], 20.7], [[6.572264050358812, 7.318510106818129], 20.8], [[6.511964927179328, 7.298546445676224], 20.9], [[6.451665803999844, 7.2785827845343185], 21.0], [[6.39136668082036, 7.258619123392413], 21.1], [[6.331067557640876, 7.238655462250508], 21.2], [[6.270768434461392, 7.218691801108602], 21.3], [[6.210469311281908, 7.198728139966697], 21.4], [[6.1501701881024236, 7.1787644788247915], 21.5], [[6.0898710649229395, 7.158800817682886], 21.6], [[6.0295719417434555, 7.138837156540981], 21.7], [[5.969272818563971, 7.118873495399074], 21.8], [[5.908973695384487, 7.098909834257168], 21.9], [[5.848674572205003, 7.078946173115262], 22.0], [[5.788375449025519, 7.058982511973356], 22.1], [[5.728076325846035, 7.039018850831449], 22.2], [[5.667777202666551, 7.019055189689543], 22.3], [[5.607478079487067, 6.999091528547637], 22.4], [[5.547178956307583, 6.97912786740573], 22.5], [[5.486879833128099, 6.959164206263824], 22.6], [[5.426580709948615, 6.939200545121918], 22.7], [[5.366281586769131, 6.9192368839800125], 22.8], [[5.305982463589647, 6.899273222838106], 22.9], [[5.245683340410163, 6.8793095616962], 23.0], [[5.185384217230679, 6.859345900554294], 23.1], [[5.125085094051195, 6.839382239412387], 23.2], [[5.064785970871711, 6.819418578270481], 23.3], [[5.004486847692227, 6.799454917128575], 23.4], [[4.944187724512743, 6.7794912559866685], 23.5], [[4.8838886013332585, 6.759527594844762], 23.6], [[4.823589478153774, 6.739563933702856], 23.7], [[4.763290354974289, 6.7196002725609505], 23.8], [[4.702991231794804, 6.699636611419045], 23.9], [[4.642692108615319, 6.679672950277139], 24.0], [[4.582392985435834, 6.6597092891352325], 24.1], [[4.522093862256349, 6.639745627993326], 24.2], [[4.461794739076864, 6.61978196685142], 24.3], [[4.401495615897379, 6.599818305709514], 24.4], [[4.341196492717894, 6.579854644567607], 24.5], [[4.280897369538408, 6.559890983425701], 24.6], [[4.2205982463589224, 6.539927322283795], 24.7], [[4.160299123179437, 6.5199636611418885], 24.8], [[4.109714160953881, 6.503216136609216], 24.8], [[4.056603170582982, 6.512896159279532], 24.9], [[4.014434021548124, 6.547016351586496], 25.0], [[3.978222697713622, 6.587426669963868], 25.1], [[3.9421647383529215, 6.627973906959812], 25.2], [[3.906110526209619, 6.668524475989521], 25.3], [[3.8700564077507926, 6.70907512831553], 25.4], [[3.834002291694135, 6.749625782777338], 25.5], [[3.797948175700692, 6.790176437295352], 25.6], [[3.7618940597089576, 6.830727091814884], 25.7], [[3.7258399437172707, 6.871277746334459], 25.8], [[3.689785827725585, 6.911828400854035], 25.9], [[3.6537317117338994, 6.952379055373611], 26.0], [[3.617677595742214, 6.992929709893187], 26.1], [[3.581623479750528, 7.033480364412763], 26.2], [[3.5455693637588426, 7.074031018932339], 26.3], [[3.509515247767157, 7.114581673451915], 26.4], [[3.4734611317754713, 7.155132327971491], 26.5], [[3.4374070157837857, 7.195682982491067], 26.6], [[3.4013528997921, 7.236233637010643], 26.7], [[3.3652987838004145, 7.276784291530219], 26.8], [[3.329244667808729, 7.317334946049795], 26.9], [[3.2931905518170432, 7.357885600569371], 27.0], [[3.2571364358253576, 7.398436255088947], 27.1], [[3.221082319833672, 7.438986909608523], 27.2], [[3.1850282038419864, 7.479537564128099], 27.3], [[3.1489740878503008, 7.5200882186476745], 27.4], [[3.112919971858615, 7.5606388731672505], 27.5], [[3.0768658558669295, 7.601189527686826], 27.6], [[3.0408117398752434, 7.641740182206403], 27.7], [[3.0047576238835574, 7.68229083672598], 27.8], [[2.9687035078918713, 7.722841491245557], 27.9], [[2.9326493919001853, 7.763392145765134], 28.0], [[2.896595275908499, 7.803942800284711], 28.1], [[2.860541159916813, 7.8444934548042875], 28.2], [[2.824487043925127, 7.885044109323864], 28.3], [[2.788432927933441, 7.925594763843441], 28.4], [[2.752378811941755, 7.966145418363018], 28.5], [[2.716324695950069, 8.006696072882594], 28.6], [[2.6802705799583824, 8.047246727402172], 28.7], [[2.644216463966696, 8.08779738192175], 28.8], [[2.6081623479750093, 8.128348036441327], 28.9], [[2.572108231983323, 8.168898690960905], 29.0], [[2.536054115991636, 8.20944934548048], 29.1]]


    lst= [[3.0, 1.0], [2.3, 3.3], [1.3, 6.7], [3.3, 6.3], [5.0, 5.5], [5.3, 7.3]]
    stl = 'eventually(x>2 and x<2.5 and y>3 and y<3.5) and ((x>2 and x<2.5 and y>3 and y<3.5) implies eventually(x>1 and x<1.5 and y>6.5 and y<7)) and ((x>1 and x<1.5 and y>6.5 and y<7) implies eventually(x>3 and x<3.5 and y>6 and y<6.5)) and ((x>3 and x<3.5 and y>6 and y<6.5) implies eventually(x>5 and x<5.5 and y>7 and y<7.5)) and always(not(x>0 and x<1 and y>4.999 and y<5.1)) and always(not(x>3 and x<5 and y>4.999 and y<5.1)) and always(not(x>3.999 and x<4.1 and y<8 and y>3)) and always(not(x>3.999 and x<4.1 and y<1 and y>0)) and always(not(x>7 and x<8 and y>4.999 and y<5.1))'
    robustness_value = stl_monitor_for_target(lst,stl)
    print(f"鲁棒性值为: {robustness_value}")

